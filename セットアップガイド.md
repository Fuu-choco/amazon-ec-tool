# セットアップガイド

## 前提条件

### 必要なソフトウェア
- **Python**: 3.8以上
- **Git**: 最新版
- **pip**: Pythonパッケージマネージャー
- **仮想環境**: venv または conda

### 必要なアカウント
- **AWSアカウント**: Amazon Product Advertising API利用のため
- **Googleアカウント**: Google Sheets API利用のため

## 環境構築手順

### 1. プロジェクトディレクトリの作成

```bash
# プロジェクトディレクトリを作成
mkdir amazon-ec-tool
cd amazon-ec-tool

# Gitリポジトリを初期化
git init
```

### 2. 仮想環境のセットアップ

```bash
# 仮想環境を作成
python -m venv venv

# 仮想環境をアクティベート
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

### 3. 必要なライブラリのインストール

```bash
# 基本ライブラリのインストール
pip install requests
pip install boto3
pip install pandas
pip install numpy
pip install google-api-python-client
pip install gspread
pip install oauth2client
pip install PyYAML
pip install python-dotenv
pip install schedule
pip install cryptography
pip install redis

# 開発用ライブラリ
pip install pytest
pip install black
pip install flake8
pip install mypy
```

### 4. プロジェクト構造の作成

```bash
# ディレクトリ構造を作成
mkdir -p src/{amazon_api,data_processor,google_sheets,utils}
mkdir -p tests
mkdir -p data/{raw,processed}
mkdir -p logs
mkdir -p config
mkdir -p docs
```

## Amazon API セットアップ

### 1. AWSアカウントの準備

1. **AWSアカウントの作成**
   - [AWS公式サイト](https://aws.amazon.com/)でアカウントを作成
   - クレジットカード情報の登録が必要

2. **IAMユーザーの作成**
   ```bash
   # AWS CLIのインストール（まだの場合）
   pip install awscli
   
   # AWS CLIの設定
   aws configure
   ```

### 2. Amazon Product Advertising API の申請

1. **Amazon Associates Program への参加**
   - [Amazon Associates](https://affiliate-program.amazon.com/)に登録
   - アフィリエイトタグを取得

2. **API利用申請**
   - Amazon Product Advertising API利用申請を提出
   - 承認まで数日〜数週間かかる場合がある

### 3. 認証情報の設定

```bash
# .envファイルを作成
touch .env

# .envファイルに認証情報を追加
echo "AWS_ACCESS_KEY_ID=your_access_key_id" >> .env
echo "AWS_SECRET_ACCESS_KEY=your_secret_access_key" >> .env
echo "ASSOCIATE_TAG=your_associate_tag" >> .env
echo "AWS_REGION=us-east-1" >> .env
```

## Google Sheets API セットアップ

### 1. Google Cloud Project の作成

1. **Google Cloud Console**にアクセス
   - [Google Cloud Console](https://console.cloud.google.com/)

2. **プロジェクトの作成**
   - 新しいプロジェクトを作成
   - プロジェクト名を設定

### 2. Google Sheets API の有効化

1. **APIライブラリ**にアクセス
2. **Google Sheets API**を検索して有効化
3. **Google Drive API**も有効化

### 3. サービスアカウントの作成

1. **IAM & Admin** → **サービスアカウント**
2. **サービスアカウントを作成**
3. **キーを作成**（JSON形式）
4. ダウンロードしたJSONファイルを`credentials.json`として保存

### 4. スプレッドシートの準備

1. **新しいスプレッドシート**を作成
2. **サービスアカウントのメールアドレス**に編集権限を付与
3. **スプレッドシートID**を取得（URLから）

```bash
# .envファイルにGoogle設定を追加
echo "GOOGLE_SHEETS_CREDENTIALS_FILE=credentials.json" >> .env
echo "SPREADSHEET_ID=your_spreadsheet_id" >> .env
```

## 設定ファイルの作成

### 1. config.yaml の作成

```yaml
# config/config.yaml
amazon:
  access_key_id: ${AWS_ACCESS_KEY_ID}
  secret_access_key: ${AWS_SECRET_ACCESS_KEY}
  associate_tag: ${ASSOCIATE_TAG}
  region: us-east-1
  marketplace: www.amazon.co.jp
  host: webservices.amazon.co.jp

google_sheets:
  credentials_file: ${GOOGLE_SHEETS_CREDENTIALS_FILE}
  spreadsheet_id: ${SPREADSHEET_ID}

data_processing:
  batch_size: 100
  retry_attempts: 3
  retry_delay: 1
  max_concurrent_requests: 5

scheduling:
  price_update_interval: 86400  # 24時間
  stock_update_interval: 3600   # 1時間
  analysis_interval: 604800     # 1週間

logging:
  level: INFO
  file: logs/app.log
  max_size: 10MB
  backup_count: 5

database:
  type: sqlite
  path: data/amazon_ec.db

cache:
  enabled: true
  redis_host: localhost
  redis_port: 6379
  redis_db: 0
```

### 2. requirements.txt の作成

```txt
# requirements.txt
requests>=2.28.0
boto3>=1.26.0
pandas>=1.5.0
numpy>=1.24.0
google-api-python-client>=2.0.0
gspread>=5.7.0
oauth2client>=4.1.3
PyYAML>=6.0
python-dotenv>=0.21.0
schedule>=1.2.0
cryptography>=39.0.0
redis>=4.5.0
pytest>=7.3.0
black>=23.0.0
flake8>=6.0.0
mypy>=1.0.0
```

## 初期設定の確認

### 1. 設定ファイルのテスト

```python
# test_config.py
import yaml
import os
from dotenv import load_dotenv

def test_config():
    load_dotenv()
    
    with open('config/config.yaml', 'r') as file:
        config = yaml.safe_load(file)
    
    # 環境変数の確認
    required_vars = [
        'AWS_ACCESS_KEY_ID',
        'AWS_SECRET_ACCESS_KEY',
        'ASSOCIATE_TAG',
        'GOOGLE_SHEETS_CREDENTIALS_FILE',
        'SPREADSHEET_ID'
    ]
    
    for var in required_vars:
        if not os.getenv(var):
            print(f"警告: {var} が設定されていません")
        else:
            print(f"✓ {var} が設定されています")

if __name__ == "__main__":
    test_config()
```

### 2. API接続テスト

```python
# test_apis.py
import boto3
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build

def test_amazon_api():
    try:
        # Amazon API接続テスト
        session = boto3.Session(
            aws_access_key_id=os.getenv('AWS_ACCESS_KEY_ID'),
            aws_secret_access_key=os.getenv('AWS_SECRET_ACCESS_KEY'),
            region_name=os.getenv('AWS_REGION')
        )
        print("✓ Amazon API接続成功")
    except Exception as e:
        print(f"✗ Amazon API接続失敗: {e}")

def test_google_sheets_api():
    try:
        # Google Sheets API接続テスト
        credentials = Credentials.from_service_account_file(
            os.getenv('GOOGLE_SHEETS_CREDENTIALS_FILE'),
            scopes=['https://www.googleapis.com/auth/spreadsheets']
        )
        service = build('sheets', 'v4', credentials=credentials)
        print("✓ Google Sheets API接続成功")
    except Exception as e:
        print(f"✗ Google Sheets API接続失敗: {e}")

if __name__ == "__main__":
    test_amazon_api()
    test_google_sheets_api()
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. Amazon API認証エラー
**症状**: `InvalidSignatureException` エラー
**解決方法**:
- AWS認証情報が正しく設定されているか確認
- 地域設定が正しいか確認
- アソシエイトタグが有効か確認

#### 2. Google Sheets API認証エラー
**症状**: `Invalid Credentials` エラー
**解決方法**:
- サービスアカウントキーが正しく配置されているか確認
- スプレッドシートにサービスアカウントの権限が付与されているか確認
- APIが有効化されているか確認

#### 3. レート制限エラー
**症状**: `TooManyRequestsException` エラー
**解決方法**:
- リクエスト間隔を調整
- バッチサイズを小さくする
- 指数バックオフを実装

#### 4. 環境変数が読み込まれない
**症状**: `None` が返される
**解決方法**:
- `.env`ファイルが正しい場所にあるか確認
- `python-dotenv`がインストールされているか確認
- 環境変数名が正しいか確認

## 次のステップ

1. **設定の確認**: 上記のテストスクリプトを実行
2. **API接続テスト**: 実際のAPI呼び出しをテスト
3. **基本機能の実装**: プロジェクトの基本機能を実装開始
4. **ドキュメントの更新**: 必要に応じてドキュメントを更新

## 参考リンク

- [Amazon Product Advertising API ドキュメント](https://webservices.amazon.com/paapi5/documentation/)
- [Google Sheets API ドキュメント](https://developers.google.com/sheets/api)
- [AWS SDK for Python (Boto3)](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html)
- [Google API Python Client](https://googleapis.dev/python/google-api-python-client/latest/)

このセットアップガイドに従って環境を構築することで、プロジェクトの開発を開始できます。 