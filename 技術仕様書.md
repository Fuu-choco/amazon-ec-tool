# 技術仕様書

## システムアーキテクチャ

### 全体構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Amazon API    │    │   Data Process  │    │ Google Sheets   │
│                 │    │                 │    │                 │
│ • Product Info  │───▶│ • Normalize     │───▶│ • Update Data   │
│ • Price Data    │    │ • Analyze       │    │ • Format        │
│ • Stock Info    │    │ • Transform     │    │ • Dashboard     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Amazon Product Advertising API 仕様

### API エンドポイント
- **検索API**: `https://webservices.amazon.com/paapi5/searchitems`
- **商品詳細API**: `https://webservices.amazon.com/paapi5/getitems`
- **類似商品API**: `https://webservices.amazon.com/paapi5/getsimilaritems`

### 認証方式
```python
# AWS Signature Version 4 認証
import boto3
from botocore.auth import SigV4Auth
from botocore.awsrequest import AWSRequest
```

### リクエスト制限
- **レート制限**: 1秒間に1リクエスト
- **リクエストサイズ**: 最大10KB
- **レスポンスサイズ**: 最大1MB

### 取得可能データ項目

#### 基本商品情報
```json
{
  "ASIN": "B08N5WRWNW",
  "Title": "商品タイトル",
  "Brand": "ブランド名",
  "Category": "カテゴリ",
  "ImageURL": "画像URL",
  "Description": "商品説明"
}
```

#### 価格情報
```json
{
  "CurrentPrice": {
    "Amount": 1000,
    "Currency": "JPY"
  },
  "OriginalPrice": {
    "Amount": 1200,
    "Currency": "JPY"
  },
  "DiscountPercentage": 16.67
}
```

#### 在庫・配送情報
```json
{
  "Availability": "In Stock",
  "DeliveryInfo": {
    "IsPrimeEligible": true,
    "IsFreeShippingEligible": false
  }
}
```

## データ処理仕様

### データ正規化
```python
# 価格データの正規化例
def normalize_price_data(raw_data):
    return {
        'asin': raw_data.get('ASIN'),
        'current_price': extract_price(raw_data.get('Offers', {}).get('ListPrice')),
        'original_price': extract_price(raw_data.get('Offers', {}).get('ListPrice')),
        'discount_rate': calculate_discount_rate(current_price, original_price),
        'currency': 'JPY',
        'timestamp': datetime.now().isoformat()
    }
```

### 分析機能
```python
# 価格変動分析
def analyze_price_changes(price_history):
    changes = []
    for i in range(1, len(price_history)):
        change = {
            'date': price_history[i]['date'],
            'price_change': price_history[i]['price'] - price_history[i-1]['price'],
            'change_percentage': calculate_percentage_change(
                price_history[i-1]['price'], 
                price_history[i]['price']
            )
        }
        changes.append(change)
    return changes
```

## Google Sheets API 仕様

### API 認証
```python
# Google Sheets API 認証
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build

SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
```

### スプレッドシート構造

#### 商品マスターシート
| 列 | 項目 | データ型 | 説明 |
|---|---|---|---|
| A | ASIN | Text | 商品識別番号 |
| B | Title | Text | 商品タイトル |
| C | Brand | Text | ブランド名 |
| D | Category | Text | カテゴリ |
| E | CurrentPrice | Number | 現在価格 |
| F | OriginalPrice | Number | 元価格 |
| G | DiscountRate | Number | 割引率 |
| H | Availability | Text | 在庫状況 |
| I | Rating | Number | 評価 |
| J | ReviewCount | Number | レビュー数 |
| K | LastUpdated | DateTime | 最終更新日時 |

#### 価格履歴シート
| 列 | 項目 | データ型 | 説明 |
|---|---|---|---|
| A | Date | Date | 日付 |
| B | ASIN | Text | 商品識別番号 |
| C | Price | Number | 価格 |
| D | PriceChange | Number | 価格変動 |
| E | ChangePercentage | Number | 変動率 |

## データベース設計

### ローカルSQLiteデータベース
```sql
-- 商品テーブル
CREATE TABLE products (
    asin TEXT PRIMARY KEY,
    title TEXT,
    brand TEXT,
    category TEXT,
    image_url TEXT,
    description TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 価格履歴テーブル
CREATE TABLE price_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    asin TEXT,
    price REAL,
    currency TEXT,
    timestamp TIMESTAMP,
    FOREIGN KEY (asin) REFERENCES products(asin)
);

-- 在庫履歴テーブル
CREATE TABLE stock_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    asin TEXT,
    availability TEXT,
    timestamp TIMESTAMP,
    FOREIGN KEY (asin) REFERENCES products(asin)
);
```

## エラーハンドリング

### API エラー処理
```python
class AmazonAPIError(Exception):
    """Amazon API エラーの基底クラス"""
    pass

class RateLimitError(AmazonAPIError):
    """レート制限エラー"""
    pass

class AuthenticationError(AmazonAPIError):
    """認証エラー"""
    pass

def handle_api_error(response):
    if response.status_code == 429:
        raise RateLimitError("API rate limit exceeded")
    elif response.status_code == 401:
        raise AuthenticationError("Invalid credentials")
    elif response.status_code >= 500:
        raise AmazonAPIError(f"Server error: {response.status_code}")
```

### リトライ機能
```python
import time
from functools import wraps

def retry_on_error(max_retries=3, delay=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except RateLimitError:
                    if attempt < max_retries - 1:
                        time.sleep(delay * (2 ** attempt))  # 指数バックオフ
                        continue
                    raise
            return func(*args, **kwargs)
        return wrapper
    return decorator
```

## ログ設定

### ログレベル設定
```python
import logging

# ログ設定
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)

# 各モジュール用ロガー
amazon_logger = logging.getLogger('amazon_api')
sheets_logger = logging.getLogger('google_sheets')
data_logger = logging.getLogger('data_processor')
```

## 設定管理

### 設定ファイル構造
```yaml
# config.yaml
amazon:
  access_key_id: ${AWS_ACCESS_KEY_ID}
  secret_access_key: ${AWS_SECRET_ACCESS_KEY}
  associate_tag: ${ASSOCIATE_TAG}
  region: us-east-1
  marketplace: www.amazon.co.jp

google_sheets:
  credentials_file: credentials.json
  spreadsheet_id: ${SPREADSHEET_ID}

data_processing:
  batch_size: 100
  retry_attempts: 3
  retry_delay: 1

scheduling:
  price_update_interval: 86400  # 24時間
  stock_update_interval: 3600   # 1時間
  analysis_interval: 604800     # 1週間

logging:
  level: INFO
  file: logs/app.log
  max_size: 10MB
  backup_count: 5
```

## パフォーマンス最適化

### バッチ処理
```python
def process_products_in_batches(products, batch_size=100):
    """商品データをバッチ処理"""
    for i in range(0, len(products), batch_size):
        batch = products[i:i + batch_size]
        yield process_batch(batch)
```

### キャッシュ機能
```python
import redis
import json

class CacheManager:
    def __init__(self):
        self.redis_client = redis.Redis(host='localhost', port=6379, db=0)
    
    def get_cached_data(self, key):
        data = self.redis_client.get(key)
        return json.loads(data) if data else None
    
    def set_cached_data(self, key, data, expire=3600):
        self.redis_client.setex(key, expire, json.dumps(data))
```

## セキュリティ仕様

### 認証情報管理
```python
import os
from dotenv import load_dotenv

load_dotenv()

# 環境変数から認証情報を取得
AWS_ACCESS_KEY_ID = os.getenv('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.getenv('AWS_SECRET_ACCESS_KEY')
ASSOCIATE_TAG = os.getenv('ASSOCIATE_TAG')
```

### データ暗号化
```python
from cryptography.fernet import Fernet

class DataEncryption:
    def __init__(self, key):
        self.cipher = Fernet(key)
    
    def encrypt(self, data):
        return self.cipher.encrypt(data.encode())
    
    def decrypt(self, encrypted_data):
        return self.cipher.decrypt(encrypted_data).decode()
```

## テスト仕様

### 単体テスト
```python
import unittest
from unittest.mock import Mock, patch

class TestAmazonAPI(unittest.TestCase):
    @patch('requests.get')
    def test_get_product_info(self, mock_get):
        # モックレスポンスの設定
        mock_response = Mock()
        mock_response.json.return_value = {
            'ItemsResult': {
                'Items': [{'ASIN': 'B08N5WRWNW'}]
            }
        }
        mock_get.return_value = mock_response
        
        # テスト実行
        result = get_product_info('B08N5WRWNW')
        self.assertIsNotNone(result)
```

### 統合テスト
```python
class TestDataFlow(unittest.TestCase):
    def test_amazon_to_sheets_flow(self):
        # 1. Amazon APIからデータ取得
        product_data = get_amazon_product_data('B08N5WRWNW')
        
        # 2. データ処理
        processed_data = process_product_data(product_data)
        
        # 3. Google Sheetsに反映
        update_result = update_google_sheets(processed_data)
        
        # 4. 結果検証
        self.assertTrue(update_result['success'])
``` 